input {
  file {
    id => "nginx_access"
    path => ["/var/log/nginx/access.log"]
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb_access"
    mode => "read"
    codec => "json"
  }

  file {
    id => "nginx_error"
    path => ["/var/log/nginx/error.log"]
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb_error"
    mode => "read"
    codec => "plain"
  }
}

filter {
  # Пренасяме основните JSON полета нагоре
  mutate {
    rename => { "[remote_addr]" => "client_ip" }
    rename => { "[status]" => "status_code" }
    rename => { "[request]" => "request_line" }
    rename => { "[request_time]" => "request_time" }
    rename => { "[upstream_addr]" => "upstream_addr" }
    rename => { "[body_bytes_sent]" => "bytes_sent" }
  }

  # Маркираме типа на лога
  if [path] =~ "access.log" {
    mutate { add_field => { "log_type" => "nginx_access" } }
  } else if [path] =~ "error.log" {
    mutate { add_field => { "log_type" => "nginx_error" } }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "nginx-logs-%{+YYYY.MM.dd}"
  }

  # За дебъг — можеш временно да активираш:
  # stdout { codec => rubydebug }
}
